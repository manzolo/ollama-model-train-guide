name: Test Dataset Training Example

on:
  push:
    branches: [ main, master ]
    paths:
      - 'models/examples/techcorp-support/**'
      - 'data/training/techcorp-support.jsonl'
      - 'scripts/test-techcorp-example.sh'
      - 'docs/dataset-training-example.md'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-techcorp-example:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create .env file
      run: make setup

    - name: Start Ollama service
      run: make up

    - name: Wait for Ollama to be ready
      run: |
        echo "Waiting for Ollama service to be ready..."
        timeout 60 bash -c 'until curl -f http://localhost:11434/api/tags 2>/dev/null; do sleep 2; done'
        echo "Ollama is ready!"

    - name: Pull base model
      run: |
        echo "Pulling llama3.2:1b base model for TechCorp example..."
        docker compose exec ollama ollama pull llama3.2:1b
        echo "Base model ready!"

    - name: Verify dataset and Modelfile exist
      run: |
        echo "Checking required files..."
        ls -la data/training/ || echo "data/training/ directory not found"
        ls -la models/examples/techcorp-support/ || echo "models/examples/techcorp-support/ directory not found"

        if [ ! -f "data/training/techcorp-support.jsonl" ]; then
          echo "ERROR: Dataset not found at data/training/techcorp-support.jsonl"
          echo "Creating it now..."
          mkdir -p data/training
          cat > data/training/techcorp-support.jsonl << 'EOF'
{"instruction": "How do I reset my password?", "output": "To reset your password: 1. Go to login page 2. Click 'Forgot Password' 3. Enter your email 4. Check your inbox for the reset link 5. Follow the link and create a new password"}
{"instruction": "What are your business hours?", "output": "TechCorp support is available Monday-Friday 9:00-18:00 CET. For urgent issues outside these hours, please email emergency@techcorp.com"}
{"instruction": "How do I contact sales?", "output": "You can contact our sales team at sales@techcorp.com or call +39 055 1234567 during business hours (Mon-Fri 9:00-18:00 CET)"}
{"instruction": "Where are you located?", "output": "TechCorp headquarters is located in Florence, Italy. We also have offices in Milan and Rome."}
{"instruction": "Do you offer refunds?", "output": "Yes, we offer a 30-day money-back guarantee on all products. Contact support@techcorp.com with your order number to initiate a refund."}
{"instruction": "How long does shipping take?", "output": "Standard shipping within Italy takes 2-3 business days. Express shipping is available for next-day delivery in major cities."}
{"instruction": "What payment methods do you accept?", "output": "We accept credit cards (Visa, Mastercard, American Express), PayPal, bank transfer, and Apple Pay."}
{"instruction": "How do I track my order?", "output": "You'll receive a tracking number via email once your order ships. Use this number on our website's tracking page or the courier's website."}
{"instruction": "Can I change my order after placing it?", "output": "Yes, you can modify your order within 2 hours of placing it. Contact support@techcorp.com with your order number and requested changes."}
{"instruction": "What's your return policy?", "output": "Items can be returned within 30 days of delivery in original condition. Return shipping is free for defective items, otherwise customer pays return shipping."}
EOF
        fi

        if [ ! -f "models/examples/techcorp-support/Modelfile" ]; then
          echo "ERROR: Modelfile not found at models/examples/techcorp-support/Modelfile"
          exit 1
        fi

        echo "✓ Dataset found ($(wc -l < data/training/techcorp-support.jsonl) examples)"
        echo "✓ Modelfile found"
        echo ""
        echo "Sample dataset entry:"
        head -1 data/training/techcorp-support.jsonl

    - name: Test TechCorp Customer Support Example
      run: |
        echo "Testing dataset-based customer support model..."
        echo "This demonstrates few-shot learning with MESSAGE examples"
        bash scripts/test-techcorp-example.sh

    - name: List models (for debugging)
      if: always()
      run: make list-models

    - name: Show logs on failure
      if: failure()
      run: make logs

    - name: Cleanup
      if: always()
      run: make down
