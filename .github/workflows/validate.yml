name: Validate Configuration

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Validate Docker Compose file
      run: docker compose config

    - name: Check Makefile syntax
      run: make help

    - name: Validate all scripts are executable
      run: |
        echo "Checking script permissions..."
        find scripts -name "*.sh" -type f ! -executable -print | while read file; do
          echo "ERROR: $file is not executable"
          exit 1
        done
        echo "All scripts are executable ✓"

    - name: Validate example Modelfiles exist
      run: |
        echo "Checking example Modelfiles..."
        for example in chatbot code-assistant creative-writer personal-assistant translator; do
          if [ ! -f "models/examples/$example/Modelfile" ]; then
            echo "ERROR: models/examples/$example/Modelfile not found"
            exit 1
          fi
          echo "✓ models/examples/$example/Modelfile"
        done
        echo "All example Modelfiles found ✓"

    - name: Validate directory structure
      run: |
        echo "Checking directory structure..."
        for dir in data/gguf data/adapters data/training models/custom models/saved; do
          if [ ! -d "$dir" ]; then
            echo "Creating missing directory: $dir"
            mkdir -p "$dir"
          fi
          echo "✓ $dir"
        done
        echo "Directory structure valid ✓"

    - name: Check for required files
      run: |
        echo "Checking required files..."
        required_files=(
          "docker-compose.yml"
          "Makefile"
          ".env.example"
          "README.md"
          "CLAUDE.md"
        )
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "ERROR: Required file $file not found"
            exit 1
          fi
          echo "✓ $file"
        done
        echo "All required files present ✓"
